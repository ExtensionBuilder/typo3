/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{LitElement as k,nothing as y,html as g}from"lit";import{property as c,customElement as L}from"lit/decorators.js";import h from"@typo3/backend/modal.js";import f from"@typo3/backend/notification.js";import w from"@typo3/backend/severity.js";import m from"@typo3/backend/storage/browser-session.js";import b from"@typo3/core/ajax/ajax-request.js";import{showDependencyModal as x}from"@typo3/extensionmanager/dependency-check.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/progress-bar-element.js";import i from"~labels/extensionmanager.messages";var a=function(u,e,t,l){var n=arguments.length,o=n<3?e:l===null?l=Object.getOwnPropertyDescriptor(e,t):l,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(u,e,t,l);else for(var d=u.length-1;d>=0;d--)(s=u[d])&&(o=(n<3?s(o):n>3?s(e,t,o):s(e,t))||o);return n>3&&o&&Object.defineProperty(e,t,o),o},p;let r=class extends k{constructor(){super(...arguments),this.installed=!1,this.label="",this.showLabel=!1}static{p=this}static{this.focusSessionKey="extensionManager.focusExtension"}connectedCallback(){super.connectedCallback(),m.get(p.focusSessionKey)===this.extensionKey&&(m.unset(p.focusSessionKey),this.updateComplete.then(()=>{this.querySelector("button")?.focus()}))}createRenderRoot(){return this}render(){if(!this.url)return y;const e="actions-system-extension-"+(this.installed?"uninstall":"install");return g`<button type=button class="btn btn-default" title=${this.label} @click=${this.handleClick}><typo3-backend-icon identifier=${e} size=small></typo3-backend-icon>${this.showLabel?g`${this.label}`:y}</button>`}handleClick(e){e.preventDefault();const t=document.createElement("typo3-backend-progress-bar");document.body.appendChild(t),t.start();const l=this.installed?i.get("dependencyCheck.modalTitle.deactivate",[this.extensionKey]):i.get("dependencyCheck.modalTitle.activate",[this.extensionKey]),n=()=>{m.set(p.focusSessionKey,this.extensionKey),top.location.reload()};new b(this.checkUrl).post({}).then(async o=>{const s=await o.resolve();if(t.done(),s.error){f.error(i.get("extensionList.dependenciesResolveInstallError.title"),s.error);return}if(s.hasDependencyErrors&&s.dependencies&&s.skipDependencyUri){const E=x(this.extensionKey,s.dependencies,s.skipDependencyUri,n);this.focusButtonOnModalHidden(E);return}const d=this.installed?i.get("extensionList.deactivate"):i.get("extensionList.activate"),v=h.confirm(l,i.get("extensionList.toggleStateConfirmation.reloadMessage"),w.warning,[{text:i.get("button.cancel"),active:!0,btnClass:"btn-default",trigger:()=>{h.dismiss()}},{text:d,btnClass:"btn-warning",trigger:()=>{h.dismiss(),this.performToggle(n)}}]);this.focusButtonOnModalHidden(v)},()=>{t.done(),f.error(i.get("extensionList.dependenciesResolveInstallError.title"),i.get("extensionList.dependenciesResolveInstallError.message"))})}performToggle(e){const t=document.createElement("typo3-backend-progress-bar");document.body.appendChild(t),t.start(),new b(this.url).post({}).then(async l=>{const n=await l.resolve();if(n.success){e();return}if(t.done(),n.dependencies&&n.skipDependencyUri){const o=x(this.extensionKey,n.dependencies,n.skipDependencyUri,e);this.focusButtonOnModalHidden(o)}else n.error&&f.error(i.get("extensionList.dependenciesResolveInstallError.title"),n.error)},()=>{t.done(),f.error(i.get("extensionList.dependenciesResolveInstallError.title"),i.get("extensionList.dependenciesResolveInstallError.message"))})}focusButtonOnModalHidden(e){e.addEventListener("typo3-modal-hidden",()=>{this.querySelector("button")?.focus()})}};a([c({type:String,attribute:"check-url"})],r.prototype,"checkUrl",void 0),a([c({type:String})],r.prototype,"url",void 0),a([c({type:String,attribute:"extension-key"})],r.prototype,"extensionKey",void 0),a([c({type:Boolean})],r.prototype,"installed",void 0),a([c({type:String})],r.prototype,"label",void 0),a([c({type:Boolean,attribute:"show-label"})],r.prototype,"showLabel",void 0),r=p=a([L("typo3-extension-toggle-button")],r);export{r as ExtensionToggleButton};
